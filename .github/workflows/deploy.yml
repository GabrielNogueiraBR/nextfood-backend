# References:
# https://devcenter.heroku.com/articles/container-registry-and-runtime
# https://enlear.academy/how-to-deploy-a-dockerized-web-app-to-heroku-using-the-github-actions-f16c00b19621

# Your workflow name.
name: Deploy to heroku.

# Run workflow on every push to master branch.
on:
  push:
    branches: [master]

# Your workflows jobs.
jobs:

  deploy:
    name: Deploy to Heroku
    runs-on: ubuntu-latest
    steps:
      # Check-out your repository.
      - name: Checkout
        uses: actions/checkout@v2

      # Add environment variable to .env
      - name: "Configure Environment"
        run:  |
          touch .env
          echo NODE_ENV="production" >> .env
          echo DB_HOST="ec2-3-217-113-25.compute-1.amazonaws.com" >> .env
          echo DB_PORT=5432 >> .env
          echo DB_USERNAME="waqwrjrakglkzt" >> .env
          echo DB_PASSWORD="0a6230abc3b6ad2f74a232331094977aae5abaf5b68731186f918cbd8df30e1f" >> .env
          echo DB_DATABASE="dakt6qonqh4j1" >> .env

      # Login to Heroku Container Registry.
      - name: Login to Heroku Container registry
        env: 
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: heroku container:login 

      # Push docker image to Heroku Container Registry.
      - name: Building and pushing image
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: heroku container:push -a ${{ secrets.HEROKU_APP_NAME }} web 

      # Release the Docker image to Heroku Container Registry.
      - name: Release app
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: heroku container:release -a ${{ secrets.HEROKU_APP_NAME }} web 
